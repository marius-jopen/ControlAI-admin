# Admin Panel Setup Guide

## Quick Start

### 1. Install Dependencies

```bash
npm install
```

### 2. Configure Environment

Copy the example environment file and update it with your Supabase credentials:

```bash
cp .env.example .env
```

Edit `.env`:
```env
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key-here
VITE_BACKEND_URL=http://localhost:3001
```

**Important**: Use the same Supabase credentials as your `controlai-server`.

### 3. Grant Admin Access

To access the admin panel, your user account must have admin status in the database.

Run this SQL in your Supabase SQL Editor:

```sql
-- Replace 'your-user-id' with your actual user UUID
-- You can find your user ID in the Supabase Dashboard > Authentication > Users

UPDATE user_app_settings
SET status = 'admin'
WHERE user_id = 'your-user-id'
AND app_id = 'limn';  -- or any app you have access to
```

### 4. Run the Admin Panel

```bash
npm run dev
```

Open `http://localhost:5173` in your browser and sign in with your admin credentials.

## Features

### Current Features âœ…

- **User List**: View all registered users across all apps
- **User Details**: See user ID, registration date, and app access
- **App Information**: View which apps each user has access to, their status (active/blocked/admin), and credits
- **Image Gallery**: Browse all images generated by each user
- **App Filtering**: Filter images by app (CELINE, IFM, THELIOS, Limn)
- **Image Viewer**: Click images to view full size with metadata
- **Search**: Search users by ID (email search coming soon)
- **Last Activity**: See when users last generated content

### Upcoming Features ğŸš§

- **User Email & Names**: Display user emails and full names (requires server endpoint)
- **Edit User Roles**: Change user status (active/blocked/admin)
- **Edit Credits**: Modify user credits per app
- **User Statistics**: Show detailed usage statistics
- **Activity Logs**: View user activity timeline
- **Export Data**: Export user data and statistics
- **Bulk Operations**: Manage multiple users at once

## Architecture

### Current Implementation

The admin panel is a standalone SvelteKit application that:

1. **Authenticates** via Supabase (same auth system as main apps)
2. **Checks Admin Status** by querying `user_app_settings.status = 'admin'`
3. **Queries Data Directly** from Supabase tables:
   - `user_app_settings` â†’ user apps, credits, status
   - `resources` â†’ generated images and metadata
4. **Operates Read-Only** without server modifications

### Why User Emails Are Missing

User emails and names are stored in Supabase's `auth.users` table, which requires:
- Service role key (cannot be exposed on client)
- Server-side endpoint with admin permissions

**Current Workaround**: Users are identified by their UUID (first 8 characters shown).

**Planned Solution**: Add `/api/v1/admin/users` endpoint to `controlai-server` that:
- Verifies admin status
- Fetches user details from `auth.users`
- Returns email, name, and metadata

## Database Structure

The admin panel reads from these tables:

```sql
-- User app settings (credits, status, etc.)
user_app_settings {
  id: uuid
  user_id: uuid
  app_id: text
  status: text        -- 'active', 'blocked', or 'admin'
  credits: integer
  created_at: timestamp
  updated_at: timestamp
}

-- Generated images and content
resources {
  id: uuid
  user_id: uuid
  app: text
  tool: text
  image_url: text
  batch_name: text
  created_at: timestamp
  visibility: text
}

-- Auth users (requires service role)
auth.users {
  id: uuid
  email: text
  user_metadata: jsonb  -- contains full_name, apps, etc.
}
```

## Troubleshooting

### Can't Sign In

**Problem**: "You do not have admin access" error

**Solution**: Make sure your user has admin status in `user_app_settings`:

```sql
SELECT * FROM user_app_settings WHERE user_id = 'your-user-id';
-- Should show status = 'admin'
```

### No Users Showing

**Problem**: User list is empty

**Solution**: Check if there are records in `user_app_settings`:

```sql
SELECT COUNT(*) FROM user_app_settings;
```

If count is 0, create a test user through one of the main apps first.

### Images Not Loading

**Problem**: User selected but no images show

**Solution**: 
1. Check if user has generated any images:
```sql
SELECT COUNT(*) FROM resources WHERE user_id = 'user-id-here';
```

2. Verify S3 URLs are accessible (check CORS settings)

### Environment Variables Not Working

**Problem**: Supabase connection fails

**Solution**:
1. Verify `.env` file exists in root directory
2. Restart dev server after changing `.env`
3. Check that variable names start with `VITE_` (required for client-side access)

## Development

### File Structure

```
controlai-admin/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”œâ”€â”€ auth/          # Authentication logic
â”‚   â”‚   â”‚   â”œâ”€â”€ supabase.ts    # Supabase client & types
â”‚   â”‚   â”‚   â””â”€â”€ store.ts       # Auth store & helpers
â”‚   â”‚   â”œâ”€â”€ api/           # API client functions
â”‚   â”‚   â”‚   â””â”€â”€ client.ts      # Data fetching functions
â”‚   â”‚   â””â”€â”€ config/        # Configuration
â”‚   â”‚       â””â”€â”€ env.ts         # Environment variables
â”‚   â””â”€â”€ routes/
â”‚       â”œâ”€â”€ +layout.svelte     # Root layout (auth init)
â”‚       â”œâ”€â”€ +page.svelte       # Login page
â”‚       â””â”€â”€ admin/
â”‚           â”œâ”€â”€ +layout.svelte # Admin layout (auth guard)
â”‚           â””â”€â”€ +page.svelte   # Main admin dashboard
â”œâ”€â”€ static/                # Static assets
â”œâ”€â”€ .env                  # Environment variables (not in git)
â”œâ”€â”€ .env.example          # Environment template
â””â”€â”€ package.json          # Dependencies & scripts
```

### Key Components

**Auth System** (`src/lib/auth/`)
- `supabase.ts`: Supabase client initialization
- `store.ts`: Auth state management, sign in/out, admin checks

**API Client** (`src/lib/api/client.ts`)
- `getAllUsers()`: Fetch all users from user_app_settings
- `getUserDetails()`: Get specific user details
- `getUserImages()`: Get user's generated images
- `getUserLatestActivity()`: Get last activity timestamp

**Main Dashboard** (`src/routes/admin/+page.svelte`)
- Split layout: Users list (left) + Details panel (right)
- Real-time user selection
- Image gallery with app filtering
- Modal image viewer

### Adding Features

To add new admin features:

1. **Add API function** in `src/lib/api/client.ts`
2. **Use in component** via async/await
3. **Update UI** in `src/routes/admin/+page.svelte`

Example:
```typescript
// 1. Add API function
export async function blockUser(userId: string) {
  const { error } = await supabase
    .from('user_app_settings')
    .update({ status: 'blocked' })
    .eq('user_id', userId);
  
  if (error) throw error;
}

// 2. Use in component
async function handleBlock() {
  await blockUser(selectedUser.id);
  await loadUsers(); // Refresh
}

// 3. Add UI button
<button on:click={handleBlock}>Block User</button>
```

## Deployment

### Build for Production

```bash
npm run build
```

### Deploy to Vercel

1. Push to GitHub
2. Import in Vercel
3. Add environment variables in Vercel dashboard
4. Deploy

### Deploy to Netlify

```bash
npm run build
netlify deploy --prod --dir=build
```

## Security Notes

âš ï¸ **Important Security Considerations**:

1. **Admin-Only Access**: The admin panel checks for `status = 'admin'` in the database
2. **RLS Policies**: Supabase Row Level Security is still enforced
3. **Client-Side Limitations**: Some operations require server endpoints for security
4. **Environment Variables**: Never commit `.env` to version control
5. **Service Role Key**: Never use service role key in client-side code

## Next Steps

### Phase 1: Server Endpoints âœ… (Planned)

Add these endpoints to `controlai-server`:

- `GET /api/v1/admin/users` - Get all users with email/name
- `GET /api/v1/admin/users/:id` - Get specific user details
- `PATCH /api/v1/admin/users/:id` - Update user status/credits
- `GET /api/v1/admin/stats` - Get platform statistics

### Phase 2: Advanced Features ğŸš€ (Future)

- User activity timeline
- Bulk operations
- Email notifications
- Usage analytics
- Custom reports

---

**Need Help?** Check the main README.md or contact the development team.

